{"version":3,"kind":"Article","sha256":"b8ef4464de0dfbfe9dc18e2b0efb3d223cd1bdc255d6c8ca8a29a6de97243fc7","slug":"batch-inference","location":"/core/common_tasks/batch_inference.md","dependencies":[],"frontmatter":{"title":"Batch Inference with UMA Models","content_includes_title":false,"authors":[{"nameParsed":{"literal":"FAIR Chemistry & Collaborators","given":"FAIR Chemistry &","family":"Collaborators"},"name":"FAIR Chemistry & Collaborators","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/facebookresearch/fairchem","copyright":"Meta Platforms, Inc","numbering":{"title":{"offset":2}},"source_url":"https://github.com/facebookresearch/fairchem/blob/main/docs/core/common_tasks/batch_inference.md","edit_url":"https://github.com/facebookresearch/fairchem/edit/main/docs/core/common_tasks/batch_inference.md","exports":[{"format":"md","filename":"batch_inference.md","url":"/build/batch_inference-bf9cbcba9c5e94789a367f604e917b40.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"admonition","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Need to install fairchem-core or get UMA access or getting permissions/401 errors?","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Kd4SJ6Oakw"}],"key":"JB0hiME2Pw"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Install the necessary packages using pip, uv etc","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lpDbH9a9u1"}],"key":"Nr7DNXSUDx"}],"key":"sAttriD4bb"}],"key":"IUQVhlBAol"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"! pip install fairchem-core fairchem-data-oc fairchem-applications-cattsunami","visibility":"show","key":"fh53J0I4pu"},{"type":"outputs","id":"KMFt-_VujcOlHZhjw4kIa","children":[],"visibility":"show","key":"YmW3Ee8FTh"}],"data":{"tags":["skip-execution"]},"visibility":"show","key":"a4sLLDXRxh"},{"type":"list","ordered":true,"start":2,"spread":false,"position":{"start":{"line":14,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Get access to any necessary huggingface gated models","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"zStB9sgBJ6"}],"key":"XAVqAQCHkV"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Get and login to your Huggingface account","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Duei41Rpxe"}],"key":"qoqrwUXzRY"}],"key":"XMAjRZyfnU"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Request access to ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"sgv8kOZkjT"},{"type":"link","url":"https://huggingface.co/facebook/UMA","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"https://​huggingface​.co​/facebook​/UMA","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"WXFOCWhfp8"}],"urlSource":"https://huggingface.co/facebook/UMA","key":"tdVNPvvnyg"}],"key":"GpJEnLgQzl"}],"key":"OY7SJf4jgh"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Create a Huggingface token at ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"kRlFHfZ7ka"},{"type":"link","url":"https://huggingface.co/settings/tokens/","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"https://​huggingface​.co​/settings​/tokens/","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"NikUXow9ZX"}],"urlSource":"https://huggingface.co/settings/tokens/","key":"avEpyta4si"},{"type":"text","value":" with the permission “Permissions: Read access to contents of all public gated repos you can access”","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"pzLm3JIrdg"}],"key":"V5plYr0O7z"}],"key":"LxTJ8Tfben"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Add the token as an environment variable using ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"LRGvgTKVIl"},{"type":"inlineCode","value":"huggingface-cli login","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"bhkqgWwPUW"},{"type":"text","value":" or by setting the HF_TOKEN environment variable.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"dUwnSJbR0y"}],"key":"VDCiUSGFHb"}],"key":"wyzRSZUPsK"}],"key":"n86jRqyZKa"}],"key":"jBfeDLZ0eU"}],"key":"khfsKiF8is"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Login using the huggingface-cli utility\n! huggingface-cli login\n\n# alternatively,\nimport os\nos.environ['HF_TOKEN'] = 'MY_TOKEN'","visibility":"show","key":"bZDYheIK9q"},{"type":"outputs","id":"ZBUiccAJ9XC2e1w2oF5aR","children":[],"visibility":"show","key":"yKukovs0jD"}],"data":{"tags":["skip-execution"]},"visibility":"show","key":"NCnSHl89Dm"}],"class":"dropdown","key":"FpKHvBhAJS"},{"type":"paragraph","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"If your application requires predictions over many systems, you can run batch inference using UMA models to use compute more efficiently and improve GPU utilization.","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"iUtNVJMEvE"}],"key":"gA8pQNuOIE"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"eiO8vrKffm"}],"key":"IJiKs1Oel4"},{"type":"paragraph","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"To learn more about the different inference settings supported, see the ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"FZpk3Ccymd"},{"type":"link","url":"https://fair-chem.github.io/core/common_tasks/ase_calculator.html","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"Prediction interface documentation","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"avNcu9z3w6"}],"urlSource":"https://fair-chem.github.io/core/common_tasks/ase_calculator.html","key":"WeaNrazVTy"},{"type":"text","value":".","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"g8FrUaosJd"}],"key":"UvDbHJcZQQ"}],"key":"w7gU5EiQ1F"},{"type":"heading","depth":2,"position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"Generate Batches at Runtime","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"HKjzjw3ZgN"}],"identifier":"generate-batches-at-runtime","label":"Generate Batches at Runtime","html_id":"generate-batches-at-runtime","implicit":true,"key":"GYhDRVnD33"},{"type":"paragraph","position":{"start":{"line":40,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"The recommended way to create batches at runtime is to convert ASE ","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"pL9EruPm9x"},{"type":"inlineCode","value":"Atoms","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"k99fID7vor"},{"type":"text","value":" objects into ","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"P1EdMMT0i4"},{"type":"inlineCode","value":"AtomicData","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"upJMA47lxj"},{"type":"text","value":"\nas follows,","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"q0KVej1NqO"}],"key":"ySQhE29now"},{"type":"code","lang":"python","value":"from ase.build import bulk, molecule\nfrom fairchem.core import pretrained_mlip\nfrom fairchem.core.datasets.atomic_data import AtomicData, atomicdata_list_to_batch\n\natoms_list = [bulk(\"Pt\"), bulk(\"Cu\"), bulk(\"NaCl\", crystalstructure=\"rocksalt\", a=2.0)]\n\n# you need to assign the task_name desired\natomic_data_list = [\n    AtomicData.from_ase(atoms, task_name=\"omat\") for atoms in atoms_list\n]\nbatch = atomicdata_list_to_batch(atomic_data_list)\n\npredictor = pretrained_mlip.get_predict_unit(\"uma-s-1p1\", device=\"cuda\")\npreds = predictor.predict(batch)","position":{"start":{"line":43,"column":1},"end":{"line":58,"column":1}},"key":"TotisIVEnO"},{"type":"paragraph","position":{"start":{"line":60,"column":1},"end":{"line":62,"column":1}},"children":[{"type":"text","value":"The predictions are returned in a dictionary with single ","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"JZr8ZQllzc"},{"type":"inlineCode","value":"torch.Tensor","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"EY7q6OemIH"},{"type":"text","value":" value for each property predicted.\nsystem level properties can be accessed using the same index for the system in the ","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"i1MecOAG6u"},{"type":"inlineCode","value":"atomic_data_list","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"BkwMFyZpqo"},{"type":"text","value":", atom level\nproperties like forces can be obtained for a single system in the batch using the ","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"losaQerfoM"},{"type":"inlineCode","value":"batch.batch","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"gIKopF3P0B"},{"type":"text","value":" attribute,","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"BDsb1CNmcV"}],"key":"EiSFDpLg6W"},{"type":"code","lang":"python","value":"# energy of the first system in the batch\npreds[\"energy\"][0]\n\n# forces of the first system in the batch\npreds[\"forces\"][batch.batch == 0]","position":{"start":{"line":63,"column":1},"end":{"line":69,"column":1}},"key":"C65PbUA6vs"},{"type":"heading","depth":2,"position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"children":[{"type":"text","value":"Batch Inference Using a Dataset and DataLoader","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"StQFz3Ce7V"}],"identifier":"batch-inference-using-a-dataset-and-dataloader","label":"Batch Inference Using a Dataset and DataLoader","html_id":"batch-inference-using-a-dataset-and-dataloader","implicit":true,"key":"kqUDD1D2uH"},{"type":"paragraph","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"children":[{"type":"text","value":"If you are running predictions over more structures than you can fit in memory, you can run inference using a torch DataLoader:","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"dkM7Lpaz34"}],"key":"DE21aHvgLT"},{"type":"code","lang":"python","value":"from torch.utils.data import DataLoader\nfrom fairchem.core.datasets import AseDBDataset\nfrom fairchem.core.datasets.atomic_data import atomicdata_list_to_batch\n\ndataset = AseDBDataset(\n    config=dict(src=\"path/to/your/dataset.aselmdb\", a2g_args=dict(task_name=\"omol\"))\n)\nloader = DataLoader(dataset, batch_size=200, collate_fn=atomicdata_list_to_batch)\npredictor = pretrained_mlip.get_predict_unit(\"uma-s-1p1\", device=\"cuda\")\n\nfor batch in loader:\n    preds = predictor.predict(batch)","position":{"start":{"line":75,"column":1},"end":{"line":88,"column":1}},"key":"V6avaKAIWR"},{"type":"heading","depth":2,"position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"children":[{"type":"text","value":"Inference over Heterogeneous Batches","position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"key":"fpjB1NgkRX"}],"identifier":"inference-over-heterogeneous-batches","label":"Inference over Heterogeneous Batches","html_id":"inference-over-heterogeneous-batches","implicit":true,"key":"DU3XVgVrIx"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"mqBRX0XVaf"}],"key":"SF5FZWu0Vk"},{"type":"paragraph","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"children":[{"type":"text","value":"For cases where you want to batch systems to be computed with different task predictions (e.g., molecules and materials), you can take advantage of UMA models and do it in a single batch.","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"key":"QcRqatA4J9"}],"key":"vI3H9PXtqv"}],"key":"aerQ6qkjrh"},{"type":"code","lang":"python","value":"from ase.build import bulk, molecule\nfrom fairchem.core import pretrained_mlip\nfrom fairchem.core.datasets.atomic_data import AtomicData, atomicdata_list_to_batch\n\n# a molecule\nh2o = molecule(\"H2O\")\nh2o.info.update({\"charge\": 0, \"spin\": 1})\n\n# a bulk\npt = bulk(\"Pt\")\n\n# a catalytic surface\nslab = fcc100(\"Cu\", (3, 3, 3), vacuum=8, periodic=True)\nadsorbate = molecule(\"CO\")\nadd_adsorbate(slab, adsorbate, 2.0, \"bridge\")\n\natomic_data_list = [\n    # note that we put the molecule in a large box\n    AtomicData.from_ase(\n        h2o, task_name=\"omol\", r_data_keys=[\"spin\", \"charge\"], molecule_cell_size=12\n    ),\n    AtomicData.from_ase(pt, task_name=\"omat\"),\n    AtomicData.from_ase(slab, task_name=\"oc20\"),\n]\nbatch = atomicdata_list_to_batch(atomic_data_list)\n\npredictions = predictor.predict(batch)","position":{"start":{"line":96,"column":1},"end":{"line":124,"column":1}},"key":"K9JQFdH622"}],"key":"swvWEAXiUi"}],"key":"RJ6HRkWg1l"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"LAMMPS Integration","url":"/lammps","group":"AI/ML Models & Usage"},"next":{"title":"Batched Atomic Simulations with InferenceBatcher","url":"/inference-batcher","group":"AI/ML Models & Usage"}}},"domain":"http://localhost:3000"}