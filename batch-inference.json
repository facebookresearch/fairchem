{"version":3,"kind":"Article","sha256":"b8ef4464de0dfbfe9dc18e2b0efb3d223cd1bdc255d6c8ca8a29a6de97243fc7","slug":"batch-inference","location":"/core/common_tasks/batch_inference.md","dependencies":[],"frontmatter":{"title":"Batch Inference with UMA Models","content_includes_title":false,"authors":[{"nameParsed":{"literal":"FAIR Chemistry & Collaborators","given":"FAIR Chemistry &","family":"Collaborators"},"name":"FAIR Chemistry & Collaborators","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/facebookresearch/fairchem","copyright":"Meta Platforms, Inc","numbering":{"title":{"offset":2}},"source_url":"https://github.com/facebookresearch/fairchem/blob/main/docs/core/common_tasks/batch_inference.md","edit_url":"https://github.com/facebookresearch/fairchem/edit/main/docs/core/common_tasks/batch_inference.md","exports":[{"format":"md","filename":"batch_inference.md","url":"/build/batch_inference-815b4be76ffad37b2d7908578a00ac04.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"admonition","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Need to install fairchem-core or get UMA access or getting permissions/401 errors?","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Tu3sb67xd0"}],"key":"F1Nf3ay7nq"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Install the necessary packages using pip, uv etc","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"BIrPSarsFX"}],"key":"WAHb4dW6Vi"}],"key":"pxVUdXQncY"}],"key":"voHNsTynCy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"! pip install fairchem-core fairchem-data-oc fairchem-applications-cattsunami","visibility":"show","key":"vwMamAdPo0"},{"type":"outputs","id":"WE2sX6hEIpKrxcs4km_UH","children":[],"visibility":"show","key":"kEkXEg9N1J"}],"data":{"tags":["skip-execution"]},"visibility":"show","key":"kFkPGio8BB"},{"type":"list","ordered":true,"start":2,"spread":false,"position":{"start":{"line":14,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Get access to any necessary huggingface gated models","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"AtfvNzwkKY"}],"key":"CMHWjLIHg7"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Get and login to your Huggingface account","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"bjcmW43x2d"}],"key":"Br3gTWzbe1"}],"key":"LI0FFywEEe"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Request access to ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"xqj4ICjT9e"},{"type":"link","url":"https://huggingface.co/facebook/UMA","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"https://​huggingface​.co​/facebook​/UMA","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"Th46fAAJOJ"}],"urlSource":"https://huggingface.co/facebook/UMA","key":"jeemVjYCQO"}],"key":"aB8tNsxzVN"}],"key":"jmJN9WffQ3"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Create a Huggingface token at ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"Y0vZDuXOw7"},{"type":"link","url":"https://huggingface.co/settings/tokens/","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"https://​huggingface​.co​/settings​/tokens/","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"RshRPQul5L"}],"urlSource":"https://huggingface.co/settings/tokens/","key":"VwSNhOXewv"},{"type":"text","value":" with the permission “Permissions: Read access to contents of all public gated repos you can access”","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"Xq7JY3IWbz"}],"key":"JtwhCxuKvy"}],"key":"dJf4Q08Alk"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Add the token as an environment variable using ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"OwUI2kBj4V"},{"type":"inlineCode","value":"huggingface-cli login","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"B99ltBo3lV"},{"type":"text","value":" or by setting the HF_TOKEN environment variable.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"qTNRsOePMz"}],"key":"ary5GhLZc5"}],"key":"fgYSDa6fhO"}],"key":"pwapGkyq8W"}],"key":"rdPNA7rlxa"}],"key":"LEMPqZPJki"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Login using the huggingface-cli utility\n! huggingface-cli login\n\n# alternatively,\nimport os\nos.environ['HF_TOKEN'] = 'MY_TOKEN'","visibility":"show","key":"R9xlGkn0zx"},{"type":"outputs","id":"kTfL_puKUenTce8bVTjzv","children":[],"visibility":"show","key":"VkRH9qk4Ut"}],"data":{"tags":["skip-execution"]},"visibility":"show","key":"wowPwd53zt"}],"class":"dropdown","key":"uUkQuAbmCZ"},{"type":"paragraph","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"If your application requires predictions over many systems, you can run batch inference using UMA models to use compute more efficiently and improve GPU utilization.","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"sIfPOM0A7Z"}],"key":"JcxEf02Xk9"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"CvWVN4BQKi"}],"key":"uZplZThFFY"},{"type":"paragraph","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"To learn more about the different inference settings supported, see the ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"iyuzSLS61p"},{"type":"link","url":"https://fair-chem.github.io/core/common_tasks/ase_calculator.html","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"Prediction interface documentation","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"IP6Lv2kRR0"}],"urlSource":"https://fair-chem.github.io/core/common_tasks/ase_calculator.html","key":"PNIppqmfCC"},{"type":"text","value":".","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"GaiIG6grzT"}],"key":"h1KrsWicBl"}],"key":"ISmPGhpFeR"},{"type":"heading","depth":2,"position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"Generate Batches at Runtime","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"InKVu7QbAr"}],"identifier":"generate-batches-at-runtime","label":"Generate Batches at Runtime","html_id":"generate-batches-at-runtime","implicit":true,"key":"EaTbRyhHHg"},{"type":"paragraph","position":{"start":{"line":40,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"The recommended way to create batches at runtime is to convert ASE ","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"Z6lhWZutdF"},{"type":"inlineCode","value":"Atoms","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"oGzon8eDJv"},{"type":"text","value":" objects into ","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"JyDIwnFJCZ"},{"type":"inlineCode","value":"AtomicData","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"bE8A9K0yHM"},{"type":"text","value":"\nas follows,","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"ntw90WBeR1"}],"key":"zbzD50R4uL"},{"type":"code","lang":"python","value":"from ase.build import bulk, molecule\nfrom fairchem.core import pretrained_mlip\nfrom fairchem.core.datasets.atomic_data import AtomicData, atomicdata_list_to_batch\n\natoms_list = [bulk(\"Pt\"), bulk(\"Cu\"), bulk(\"NaCl\", crystalstructure=\"rocksalt\", a=2.0)]\n\n# you need to assign the task_name desired\natomic_data_list = [\n    AtomicData.from_ase(atoms, task_name=\"omat\") for atoms in atoms_list\n]\nbatch = atomicdata_list_to_batch(atomic_data_list)\n\npredictor = pretrained_mlip.get_predict_unit(\"uma-s-1p1\", device=\"cuda\")\npreds = predictor.predict(batch)","position":{"start":{"line":43,"column":1},"end":{"line":58,"column":1}},"key":"rGiBPZy7f3"},{"type":"paragraph","position":{"start":{"line":60,"column":1},"end":{"line":62,"column":1}},"children":[{"type":"text","value":"The predictions are returned in a dictionary with single ","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"AAhkgfl4Cw"},{"type":"inlineCode","value":"torch.Tensor","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"urPjFvu1a9"},{"type":"text","value":" value for each property predicted.\nsystem level properties can be accessed using the same index for the system in the ","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"Bn7wNPanGZ"},{"type":"inlineCode","value":"atomic_data_list","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"VuxcCPNMDB"},{"type":"text","value":", atom level\nproperties like forces can be obtained for a single system in the batch using the ","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"g56SH8DIUf"},{"type":"inlineCode","value":"batch.batch","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"oVhT21qqNP"},{"type":"text","value":" attribute,","position":{"start":{"line":60,"column":1},"end":{"line":60,"column":1}},"key":"Ufp8sAO8aH"}],"key":"LUtOilxWkl"},{"type":"code","lang":"python","value":"# energy of the first system in the batch\npreds[\"energy\"][0]\n\n# forces of the first system in the batch\npreds[\"forces\"][batch.batch == 0]","position":{"start":{"line":63,"column":1},"end":{"line":69,"column":1}},"key":"eb3OUBU2sD"},{"type":"heading","depth":2,"position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"children":[{"type":"text","value":"Batch Inference Using a Dataset and DataLoader","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"cUqQSp9sHl"}],"identifier":"batch-inference-using-a-dataset-and-dataloader","label":"Batch Inference Using a Dataset and DataLoader","html_id":"batch-inference-using-a-dataset-and-dataloader","implicit":true,"key":"mV6XDq7jt8"},{"type":"paragraph","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"children":[{"type":"text","value":"If you are running predictions over more structures than you can fit in memory, you can run inference using a torch DataLoader:","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"lhDwsSj3li"}],"key":"OSXyqeOa4i"},{"type":"code","lang":"python","value":"from torch.utils.data import DataLoader\nfrom fairchem.core.datasets import AseDBDataset\nfrom fairchem.core.datasets.atomic_data import atomicdata_list_to_batch\n\ndataset = AseDBDataset(\n    config=dict(src=\"path/to/your/dataset.aselmdb\", a2g_args=dict(task_name=\"omol\"))\n)\nloader = DataLoader(dataset, batch_size=200, collate_fn=atomicdata_list_to_batch)\npredictor = pretrained_mlip.get_predict_unit(\"uma-s-1p1\", device=\"cuda\")\n\nfor batch in loader:\n    preds = predictor.predict(batch)","position":{"start":{"line":75,"column":1},"end":{"line":88,"column":1}},"key":"hpeL6W64Nr"},{"type":"heading","depth":2,"position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"children":[{"type":"text","value":"Inference over Heterogeneous Batches","position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"key":"asLOAMRMEe"}],"identifier":"inference-over-heterogeneous-batches","label":"Inference over Heterogeneous Batches","html_id":"inference-over-heterogeneous-batches","implicit":true,"key":"r7zb42CI34"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"pXeG5Am4MC"}],"key":"F5wqONnyze"},{"type":"paragraph","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"children":[{"type":"text","value":"For cases where you want to batch systems to be computed with different task predictions (e.g., molecules and materials), you can take advantage of UMA models and do it in a single batch.","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"key":"gvR0SoK6hW"}],"key":"iLkhDA31Rk"}],"key":"PGJWdKPW5D"},{"type":"code","lang":"python","value":"from ase.build import bulk, molecule\nfrom fairchem.core import pretrained_mlip\nfrom fairchem.core.datasets.atomic_data import AtomicData, atomicdata_list_to_batch\n\n# a molecule\nh2o = molecule(\"H2O\")\nh2o.info.update({\"charge\": 0, \"spin\": 1})\n\n# a bulk\npt = bulk(\"Pt\")\n\n# a catalytic surface\nslab = fcc100(\"Cu\", (3, 3, 3), vacuum=8, periodic=True)\nadsorbate = molecule(\"CO\")\nadd_adsorbate(slab, adsorbate, 2.0, \"bridge\")\n\natomic_data_list = [\n    # note that we put the molecule in a large box\n    AtomicData.from_ase(\n        h2o, task_name=\"omol\", r_data_keys=[\"spin\", \"charge\"], molecule_cell_size=12\n    ),\n    AtomicData.from_ase(pt, task_name=\"omat\"),\n    AtomicData.from_ase(slab, task_name=\"oc20\"),\n]\nbatch = atomicdata_list_to_batch(atomic_data_list)\n\npredictions = predictor.predict(batch)","position":{"start":{"line":96,"column":1},"end":{"line":124,"column":1}},"key":"CqqUiT8OSf"}],"key":"nvPmPyL3u3"}],"key":"c9Qimq43kL"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"LAMMPS Integration","url":"/lammps","group":"AI/ML Models & Usage"},"next":{"title":"Batched Atomic Simulations with InferenceBatcher","url":"/inference-batcher","group":"AI/ML Models & Usage"}}},"domain":"http://localhost:3000"}