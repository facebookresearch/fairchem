{"version":3,"kind":"Notebook","sha256":"761748adc358046061c1acf39d7999234ca77c3327c70c20aceb2f641190081d","slug":"ase-calculator","location":"/core/common_tasks/ase_calculator.md","dependencies":[],"frontmatter":{"title":"Inference using ASE and Predictor Interface","kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"jupytext":{"text_representation":{"extension":".md","format_name":"myst","format_version":"0.13","jupytext_version":"1.17.1"}},"content_includes_title":false,"authors":[{"nameParsed":{"literal":"FAIR Chemistry & Collaborators","given":"FAIR Chemistry &","family":"Collaborators"},"name":"FAIR Chemistry & Collaborators","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/facebookresearch/fairchem","copyright":"Meta Platforms, Inc","numbering":{"title":{"offset":2}},"source_url":"https://github.com/facebookresearch/fairchem/blob/main/docs/core/common_tasks/ase_calculator.md","edit_url":"https://github.com/facebookresearch/fairchem/edit/main/docs/core/common_tasks/ase_calculator.md","exports":[{"format":"md","filename":"ase_calculator.md","url":"/build/ase_calculator-3fbc77a2111651a8debe81572b856fda.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Inference is done using ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"OWMigXBh0n"},{"type":"link","url":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/units/mlip_unit/mlip_unit.py#L867","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"MLIPPredictUnit","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"b0QyVEHlyw"}],"urlSource":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/units/mlip_unit/mlip_unit.py#L867","data":{"kind":"file","org":"facebookresearch","repo":"fairchem","reference":"main","file":"src/fairchem/core/units/mlip_unit/mlip_unit.py","from":867,"raw":"https://raw.githubusercontent.com/facebookresearch/fairchem/main/src/fairchem/core/units/mlip_unit/mlip_unit.py"},"internal":false,"protocol":"github","key":"ZJcmfGaEhC"},{"type":"text","value":". The ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"j3X8Bz8T5u"},{"type":"link","url":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/calculate/ase_calculator.py#L3","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"FairchemCalculator","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"Fq7ssSX06m"}],"urlSource":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/calculate/ase_calculator.py#L3","data":{"kind":"file","org":"facebookresearch","repo":"fairchem","reference":"main","file":"src/fairchem/core/calculate/ase_calculator.py","from":3,"raw":"https://raw.githubusercontent.com/facebookresearch/fairchem/main/src/fairchem/core/calculate/ase_calculator.py"},"internal":false,"protocol":"github","key":"fv0RJujKSD"},{"type":"text","value":" (an ASE calculator) is simply a convenience wrapper around the MLIPPredictUnit.","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"LeRR56eJsK"}],"key":"DFnEPCbodH"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"kzYnuvJcwL"}],"key":"Vk8paDB8Li"},{"type":"paragraph","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"For simple cases such as demos or education, the ASE calculator is very easy to use. For more complex cases such as running MD or batched inference, we recommend using the predictor directly for better performance.","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"Dd5xmqFoL1"}],"key":"k7iwmNh0vg"}],"key":"K2H6uEFfHS"}],"key":"UIJ8LLtyQR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from __future__ import annotations\n\nfrom fairchem.core import FAIRChemCalculator, pretrained_mlip\n\npredictor = pretrained_mlip.get_predict_unit(\"uma-s-1p1\", device=\"cuda\")\ncalc = FAIRChemCalculator(predictor, task_name=\"oc20\")","key":"S9JOjrpOyt"},{"type":"outputs","id":"9iAFPBqsYWz_IQc5HCzVw","children":[{"type":"output","children":[],"jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"checkpoints/uma-s-1p1.pt:   0%|          | 0.00/1.17G [00:00<?, ?B/s]","content_type":"text/plain"},"application/vnd.jupyter.widget-view+json":{"content":"{\"version_major\":2,\"version_minor\":0,\"model_id\":\"09838a58f40a43adb4833cb004a4c362\"}","content_type":"application/vnd.jupyter.widget-view+json"}}},"key":"ohU4btYuOU"},{"type":"output","children":[],"jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"iso_atom_elem_refs.yaml:   0%|          | 0.00/9.00k [00:00<?, ?B/s]","content_type":"text/plain"},"application/vnd.jupyter.widget-view+json":{"content":"{\"version_major\":2,\"version_minor\":0,\"model_id\":\"d982a91b86984f5c83bf88a1b00a62ac\"}","content_type":"application/vnd.jupyter.widget-view+json"}}},"key":"G1iiq2A0S5"},{"type":"output","children":[],"jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"form_elem_refs.yaml:   0%|          | 0.00/11.8k [00:00<?, ?B/s]","content_type":"text/plain"},"application/vnd.jupyter.widget-view+json":{"content":"{\"version_major\":2,\"version_minor\":0,\"model_id\":\"946a1a7d93334777b4091bd74f52bee6\"}","content_type":"application/vnd.jupyter.widget-view+json"}}},"key":"HHqd82PU0P"}],"key":"QtJ8m57Zmy"}],"key":"TKmeotR6QE"},{"type":"block","children":[{"type":"admonition","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Need to install fairchem-core or get UMA access or getting permissions/401 errors?","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"sTzphQQ8QG"}],"key":"krMRFZjbwV"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Install the necessary packages using pip, uv etc","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"XpNtihg6dN"}],"key":"ypuNdKI6V9"}],"key":"RwFEBlEKdH"}],"key":"nAUW6T5T8e"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"! pip install fairchem-core fairchem-data-oc fairchem-applications-cattsunami","visibility":"show","key":"gd0DLs9V2r"},{"type":"outputs","id":"qMi5oRiTZRAHoPHNCTe-g","children":[],"visibility":"show","key":"WW8JhcDrJj"}],"data":{"tags":["skip-execution"]},"visibility":"show","key":"kIvoEJhhcT"},{"type":"list","ordered":true,"start":2,"spread":false,"position":{"start":{"line":42,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":42,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Get access to any necessary huggingface gated models","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"QYZqIPgqc9"}],"key":"YoS1eTRdZ3"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":43,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Get and login to your Huggingface account","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"bfjEE6asX8"}],"key":"oCHWP9Q8ra"}],"key":"HGuhXPy0QE"},{"type":"listItem","spread":true,"position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Request access to ","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"QfiES9GktG"},{"type":"link","url":"https://huggingface.co/facebook/UMA","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"text","value":"https://​huggingface​.co​/facebook​/UMA","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"aTjMHUS2Pu"}],"urlSource":"https://huggingface.co/facebook/UMA","key":"v2SaHtH4Mo"}],"key":"y3MSF422bk"}],"key":"bAk8MhICI9"},{"type":"listItem","spread":true,"position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Create a Huggingface token at ","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"bnmEwoxSOA"},{"type":"link","url":"https://huggingface.co/settings/tokens/","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"https://​huggingface​.co​/settings​/tokens/","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"BDP78OWGqS"}],"urlSource":"https://huggingface.co/settings/tokens/","key":"bp3z32sm7O"},{"type":"text","value":" with the permission “Permissions: Read access to contents of all public gated repos you can access”","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"WxyskUIYHp"}],"key":"DGFXGO5TM4"}],"key":"LSolPT0woF"},{"type":"listItem","spread":true,"position":{"start":{"line":46,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Add the token as an environment variable using ","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"D7vLYtuSKt"},{"type":"inlineCode","value":"huggingface-cli login","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"O3IQcXEvRu"},{"type":"text","value":" or by setting the HF_TOKEN environment variable.","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"hdnUzsCYNf"}],"key":"tEPMNJOHiD"}],"key":"pFJ6qxRjI1"}],"key":"dLFO10GHYs"}],"key":"nSRlLAGh8D"}],"key":"nbQOwbpN6s"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Login using the huggingface-cli utility\n! huggingface-cli login\n\n# alternatively,\nimport os\nos.environ['HF_TOKEN'] = 'MY_TOKEN'","visibility":"show","key":"Onhmf2DSH8"},{"type":"outputs","id":"49gQglOUaPWsEoniY-hsl","children":[],"visibility":"show","key":"xcpddaL8dJ"}],"data":{"tags":["skip-execution"]},"visibility":"show","key":"jtZpHfmjSf"}],"class":"dropdown","key":"QS8lmsxy1w"},{"type":"heading","depth":2,"position":{"start":{"line":61,"column":1},"end":{"line":61,"column":1}},"children":[{"type":"text","value":"Default mode","position":{"start":{"line":61,"column":1},"end":{"line":61,"column":1}},"key":"fKnl5hnOOf"}],"identifier":"default-mode","label":"Default mode","html_id":"default-mode","implicit":true,"key":"WqgsVU5pHg"},{"type":"paragraph","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"children":[{"type":"text","value":"UMA is designed for both general-purpose usage (single or batched systems) and single-system long rollout (MD simulations, relaxations, etc.). For general-purpose use, we suggest using the ","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"key":"Ekb2G2xdQB"},{"type":"link","url":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/units/mlip_unit/api/inference.py#L92","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"children":[{"type":"text","value":"default settings","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"key":"tG3790HQdW"}],"urlSource":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/units/mlip_unit/api/inference.py#L92","data":{"kind":"file","org":"facebookresearch","repo":"fairchem","reference":"main","file":"src/fairchem/core/units/mlip_unit/api/inference.py","from":92,"raw":"https://raw.githubusercontent.com/facebookresearch/fairchem/main/src/fairchem/core/units/mlip_unit/api/inference.py"},"internal":false,"protocol":"github","key":"VOn8IzvUQT"},{"type":"text","value":". This is a good trade-off between accuracy, speed, and memory consumption and should suffice for most applications. In this setting, on a single 80GB H100 GPU, we expect a user should be able to compute on systems as large as 50k-100k neighbors (depending on their atomic density). Batching is also supported in this mode.","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"key":"wOrsUb73sf"}],"key":"g0Bt6tk0UW"},{"type":"heading","depth":2,"position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"children":[{"type":"text","value":"Turbo mode","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"key":"elOUy12Liv"}],"identifier":"turbo-mode","label":"Turbo mode","html_id":"turbo-mode","implicit":true,"key":"htKJMFXzuy"},{"type":"paragraph","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"For long rollout trajectory use-cases, such as molecular dynamics (MD) or relaxations, we provide a special mode called ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"lp7VJL3pnH"},{"type":"strong","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"turbo","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"L6Gtt3gnxU"}],"key":"BXTQyE4zz9"},{"type":"text","value":", which optimizes for speed but restricts the user to using a single system where the atomic composition is held constant. Turbo mode is approximately 1.5-2x faster than default mode, depending on the situation. However, batching is not supported in this mode. It can be easily activated as shown below.","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"pZNuIRa6P4"}],"key":"h4yIQqA4Ra"}],"key":"wgTcLYW2DY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"predictor = pretrained_mlip.get_predict_unit(\n    \"uma-s-1p1\", device=\"cuda\", inference_settings=\"turbo\"\n)","key":"nb23PRZNOO"},{"type":"outputs","id":"O_SMfCsd33yJ00BY8BwjC","children":[],"key":"WeJZlGFbiT"}],"key":"MTb4MzPwbQ"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"text","value":"Custom modes for advanced users","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"mUbhZCG0oF"}],"identifier":"custom-modes-for-advanced-users","label":"Custom modes for advanced users","html_id":"custom-modes-for-advanced-users","implicit":true,"key":"jyG4hzsAPI"},{"type":"paragraph","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"The advanced user might quickly see that ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"zb34NVLDqv"},{"type":"strong","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"default","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"hagTT6FcTN"}],"key":"apBOJ78ZIO"},{"type":"text","value":" mode and ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"ow2fYzlnnP"},{"type":"strong","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"turbo","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"UWQ8XA9tkg"}],"key":"NgKWsQJLMK"},{"type":"text","value":" mode are special cases of our ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"deWd1kg83g"},{"type":"link","url":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/units/mlip_unit/api/inference.py#L47","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"inference settings api","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"Wg1fknORVd"}],"urlSource":"https://github.com/facebookresearch/fairchem/blob/main/src/fairchem/core/units/mlip_unit/api/inference.py#L47","data":{"kind":"file","org":"facebookresearch","repo":"fairchem","reference":"main","file":"src/fairchem/core/units/mlip_unit/api/inference.py","from":47,"raw":"https://raw.githubusercontent.com/facebookresearch/fairchem/main/src/fairchem/core/units/mlip_unit/api/inference.py"},"internal":false,"protocol":"github","key":"PXpQZpa3PG"},{"type":"text","value":". You can customize it for your application if you understand what you are doing. The following table provides more information.","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"QKuwlnCQ5q"}],"key":"G3iJwXj2w3"},{"type":"table","position":{"start":{"line":79,"column":1},"end":{"line":85,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"Setting Flag","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"pkjui8qxKW"}],"key":"iAxkWAYH8z"},{"type":"tableCell","header":true,"position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"Description","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"Hoz96HRrkb"}],"key":"OicpH1DZ9m"}],"key":"XVNWtnWZFF"},{"type":"tableRow","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"tf32","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"jYSbCdKp6u"}],"key":"Oe2Ou4mHgJ"},{"type":"tableCell","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"enables torch ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"dyL8mwNALH"},{"type":"link","url":"https://docs.pytorch.org/docs/stable/notes/cuda.html","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"tf32","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"HjjsGsNitp"}],"urlSource":"https://docs.pytorch.org/docs/stable/notes/cuda.html","key":"KBjsB2ojOM"},{"type":"text","value":" format for matrix multiplication. This will speed up inference at a slight trade-off for precision. In our tests, it makes minimal difference to most applications. It is able to preserve equivariance, energy conservation for long rollouts. However, if you are computing higher order derivatives such as Hessians or other calculations that requires strict numerical precision, we recommend turning this off","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"hkltAMl84h"}],"key":"AqgZKpnSep"}],"key":"QjNvAVMZgB"},{"type":"tableRow","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"children":[{"type":"text","value":"activation_checkpointing","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"rWcfO6H0MG"}],"key":"hJK8O8w2bO"},{"type":"tableCell","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"children":[{"type":"text","value":"this uses a custom chunked activation checkpointing algorithm and allows significant savings in memory for a small inference speed penalty. If you are predicting on systems >1000 atoms, we recommend keeping this on. However, if you want the absolute fastest inference possible for small systems, you can turn this off","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"wvTZEDcRlz"}],"key":"W19uROYVNs"}],"key":"aIJ5t6V5Yr"},{"type":"tableRow","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"children":[{"type":"text","value":"merge_mole","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"key":"RDtmeOglzq"}],"key":"EBExtJ37Et"},{"type":"tableCell","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"children":[{"type":"text","value":"This is useful in long rollout applications where the system composition stays constant. By pre-merge the MoLE weights, we can save both memory and compute.","position":{"start":{"line":83,"column":1},"end":{"line":83,"column":1}},"key":"iuFhno7H6P"}],"key":"sK3jLFUuOz"}],"key":"lRch6vvym4"},{"type":"tableRow","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"text","value":"compile","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"key":"oKyPxcMiF5"}],"key":"EBN4kje3Ls"},{"type":"tableCell","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"text","value":"This uses torch.compile to significantly speed up computation. Due to the way pytorch traces the internal graph, it requires a long compile time during the first iteration and can even recompile anytime it detected a significant change in input dimensions. It is not recommended if you are computing frequently on very different atomic systems.","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"key":"aYL5DUx6rZ"}],"key":"Db90iCCRoA"}],"key":"EsUwcXgy8e"},{"type":"tableRow","position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"children":[{"type":"text","value":"external_graph_gen","position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"key":"sp1NobWaXX"}],"key":"V5GSgAEelE"},{"type":"tableCell","position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"children":[{"type":"text","value":"Only use this if you want to use an external graph generator. This should be rarely used except for development","position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"key":"cY4GPvdHfC"}],"key":"x7AdYQO3X2"}],"key":"E4MmjGKpOW"}],"key":"sBnmkaCWYL"},{"type":"paragraph","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"children":[{"type":"text","value":"For example, for an MD simulation use-case for a system of ~500 atoms, we can choose to use a custom mode like the following:","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"O2SyZVpkhr"}],"key":"d5JgfkOSvt"}],"key":"ZvPkQehhFB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from fairchem.core.units.mlip_unit.api.inference import InferenceSettings\n\nsettings = InferenceSettings(\n    tf32=True,\n    activation_checkpointing=False,\n    merge_mole=True,\n    compile=True,\n    external_graph_gen=False,\n    internal_graph_gen_version=2,\n)\n\npredictor = pretrained_mlip.get_predict_unit(\n    \"uma-s-1p1\", device=\"cuda\", inference_settings=settings\n)","key":"aaoEEEtbBF"},{"type":"outputs","id":"Eq1TDzzXo0d3vDKl08Pak","children":[],"key":"yOlwjdrEiv"}],"key":"KATLjfvwZw"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":106,"column":1},"end":{"line":106,"column":1}},"children":[{"type":"text","value":"Multi-GPU Inference","position":{"start":{"line":106,"column":1},"end":{"line":106,"column":1}},"key":"iRRMu0ksbV"}],"identifier":"multi-gpu-inference","label":"Multi-GPU Inference","html_id":"multi-gpu-inference","implicit":true,"key":"PkEtmfNY6R"},{"type":"paragraph","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"children":[{"type":"text","value":"UMA supports Graph Parallel inference natively. The graph is chunked into each rank and both the forward and backwards communication is handled by the built-in graph parallel algorithm with torch distributed. Because Multi-GPU inference requires special setup of communication protocols within a node and across nodes, we leverage ","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"key":"NnRxoMQNd5"},{"type":"link","url":"https://www.ray.io/","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"children":[{"type":"text","value":"ray","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"key":"eXE3Khc4R9"}],"urlSource":"https://www.ray.io/","key":"bXLgpYGbTI"},{"type":"text","value":" to launch Ray Actors for each GPU-rank under the hood. This allows us to seamlessly scale to any infrastructure that can run Ray.","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"key":"wssRCq04eE"}],"key":"LRuWIuhAXU"},{"type":"paragraph","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"children":[{"type":"text","value":"To make things simple for the user that wants to run multi-gpu inference locally, we provide a drop-in replacement for MLIPPredictUnit, called ","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"IHNl0gqWx4"},{"type":"link","url":"https://github.com/facebookresearch/fairchem/blob/85bd83535fedbc1d99eee4c12e175603ccc44ef7/src/fairchem/core/units/mlip_unit/predict.py#L415","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"children":[{"type":"text","value":"ParallelMLIPPredictUnit","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"NV4chAnnRD"}],"urlSource":"https://github.com/facebookresearch/fairchem/blob/85bd83535fedbc1d99eee4c12e175603ccc44ef7/src/fairchem/core/units/mlip_unit/predict.py#L415","data":{"kind":"file","org":"facebookresearch","repo":"fairchem","reference":"85bd83535fedbc1d99eee4c12e175603ccc44ef7","file":"src/fairchem/core/units/mlip_unit/predict.py","from":415,"raw":"https://raw.githubusercontent.com/facebookresearch/fairchem/85bd83535fedbc1d99eee4c12e175603ccc44ef7/src/fairchem/core/units/mlip_unit/predict.py"},"internal":false,"protocol":"github","key":"hCmz0IrwRi"}],"key":"RZz0kBqNDt"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"CI14ZYFIcp"}],"key":"cnNuiLZPhu"},{"type":"paragraph","position":{"start":{"line":113,"column":1},"end":{"line":113,"column":1}},"children":[{"type":"text","value":"To enable multi-GPU inference, you need to install Ray manually or through the fairchem extra dependencies option.","position":{"start":{"line":113,"column":1},"end":{"line":113,"column":1}},"key":"CHrhWYI4hT"}],"key":"rOQkNCLmnn"}],"key":"uhF8PJKNs8"},{"type":"code","lang":"bash","value":"pip install fairchem-core[extras]","position":{"start":{"line":116,"column":1},"end":{"line":118,"column":1}},"key":"pczJqiN5m7"},{"type":"paragraph","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"children":[{"type":"text","value":"For example, we can create a predictor with 8 GPU workers in a very similar way to MLIPPredictUnit and perform an MD calculation with the ASE calculator. This mode of operation is also compatible with our LAMMPS integration.","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"RvtACoOzwQ"}],"key":"T48pwbTlSb"},{"type":"code","lang":"python","value":"from ase import units\nfrom ase.md.langevin import Langevin\nfrom fairchem.core import pretrained_mlip, FAIRChemCalculator\nimport time\n\nfrom fairchem.core.datasets.common_structures import get_fcc_crystal_by_num_atoms\n\npredictor = pretrained_mlip.get_predict_unit(\n    \"uma-s-1p1\", inference_settings=\"turbo\", device=\"cuda\", workers=1\n)\ncalc = FAIRChemCalculator(predictor, task_name=\"omat\")\n\natoms = get_fcc_crystal_by_num_atoms(8000)\natoms.calc = calc\n\ndyn = Langevin(\n    atoms,\n    timestep=0.1 * units.fs,\n    temperature_K=400,\n    friction=0.001 / units.fs,\n)\n# warmup 10 steps\ndyn.run(steps=10)\nstart_time = time.time()\ndyn.attach(\n    lambda: print(\n        f\"Step: {dyn.get_number_of_steps()}, E: {atoms.get_potential_energy():.3f} eV, \"\n        f\"QPS: {dyn.get_number_of_steps()/(time.time()-start_time):.2f}\"\n    ),\n    interval=1,\n)\ndyn.run(steps=1000)","position":{"start":{"line":122,"column":1},"end":{"line":155,"column":1}},"key":"x5f8Wwab86"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"mWPTGkw487"}],"key":"dL1t2Psknu"},{"type":"paragraph","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"children":[{"type":"text","value":"This will automatically create a Ray server on your local machine and use a local client to connect to it. If you have set up a Ray cluster, you can leverage it to run parallel inference on as many nodes as you like.","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"key":"SQODUDqXB0"}],"key":"aZ9nqJwu12"}],"key":"kNBa6cxFCW"}],"key":"CTeetzxfaY"}],"key":"rTnSHKptS2"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Common Tasks","url":"/summary","group":"AI/ML Models & Usage"},"next":{"title":"LAMMPS Integration","url":"/lammps","group":"AI/ML Models & Usage"}}},"domain":"http://localhost:3000"}